<!doctype html>
<html><!-- InstanceBegin template="/Templates/temp.dwt" codeOutsideHTMLIsLocked="false" -->
	<head>
		  <!-- Required meta tags -->
	  <meta charset="utf-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	  <!-- InstanceBeginEditable name="doctitle" -->
	  <title>首页轮播图</title>
	  <!-- InstanceEndEditable -->
	  <!-- plugins:css -->
	  <link rel="stylesheet" href="vendors/mdi/css/materialdesignicons.min.css">
	  <link rel="stylesheet" href="vendors/base/vendor.bundle.base.css">
	  <!-- endinject -->
	  <!-- plugin css for this page -->
	  <link rel="stylesheet" href="vendors/datatables.net-bs4/dataTables.bootstrap4.css">
	  <!-- End plugin css for this page -->
	  <!-- inject:css -->
	  <link rel="stylesheet" href="css/style.css">
	  <!-- endinject -->
	  <link rel="shortcut icon" href="images/favicon.png" />
	  <script src="vendors/base/vendor.bundle.base.js"></script>
	  <script src="js/common.js"></script>
	  <!-- InstanceBeginEditable name="head" -->
	  <link rel="stylesheet" href="css/cropper.min.css">
	  <script src="js/jquery.poplayer.js"></script>
	  <script src="js/cropper.min.js"></script>
	  <!-- InstanceEndEditable -->
	</head>

	<body>
		
		<div class="container-scroller">
		  <!-- partial:partials/_navbar.html -->
  		  <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
              <div class="navbar-brand-wrapper d-flex justify-content-center">
				<div class="navbar-brand-inner-wrapper d-flex justify-content-between align-items-center w-100">  
				  <a class="navbar-brand brand-logo" href="index.html"><img src="images/logo22.png" alt="logo" height="60"/></a>
				  <a class="navbar-brand brand-logo-mini" href="index.html"><img src="images/logo.png" alt="logo"/></a>
				  <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
					<span class="mdi mdi-sort-variant"></span>
				  </button>
				</div>  
			  </div>
			  <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">

				<ul class="navbar-nav navbar-nav-right">

				  <li class="nav-item nav-profile dropdown">
					<a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="profileDropdown">
					  <span class="nav-profile-name">这里是用户名</span>
					</a>
					<div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
					  <a class="dropdown-item">
						<i class="mdi mdi-settings text-primary"></i>
						修改密码
					  </a>
					  <a class="dropdown-item">
						<i class="mdi mdi-logout text-primary"></i>
						退出登录
					  </a>
					</div>
				  </li>
				</ul>
				<button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
				  <span class="mdi mdi-menu"></span>
				</button>
			  </div>
		  </nav>
		  <div class="container-fluid page-body-wrapper">
			   <!-- partial:partials/_sidebar.html -->
			  <nav class="sidebar sidebar-offcanvas" id="sidebar">
				<ul class="nav">
				  <li class="nav-item">
					<a class="nav-link" href="manage.html">
					  <i class="mdi mdi-home menu-icon"></i>
					  <span class="menu-title">首页</span>
					</a>
				  </li>
				  <li class="nav-item">
					<a class="nav-link" data-toggle="collapse" href="#ui-basic" aria-expanded="false" aria-controls="ui-basic">
					  <i class="mdi mdi-circle-outline menu-icon"></i>
					  <span class="menu-title">轮播图管理</span>
					  <i class="menu-arrow"></i>
					</a>
					<div class="collapse" id="ui-basic">
					  <ul class="nav flex-column sub-menu">
						<li class="nav-item"> <a class="nav-link" href="banner_default.html">首页轮播图</a></li>
						<li class="nav-item"> <a class="nav-link" href="banner_cabi.html">察必页轮播图</a></li>
					  </ul>
					</div>
				  </li>
				  <li class="nav-item">
					<a class="nav-link" href="product_type.html">
					  <i class="mdi mdi-view-headline menu-icon"></i>
					  <span class="menu-title">产品系列管理</span>
					</a>
				  </li>

				  <li class="nav-item">
					<a class="nav-link" href="product_manage.html">
					  <i class="mdi mdi-grid-large menu-icon"></i>
					  <span class="menu-title">产品管理</span>
					</a>
				  </li>
					
				  <li class="nav-item">
					<a class="nav-link" href="pages/tables/basic-table.html">
					  <i class="mdi mdi-book-variant menu-icon"></i>
					  <span class="menu-title">预约管理</span>
					</a>
				  </li>
					
				  <li class="nav-item">
					<a class="nav-link" data-toggle="collapse" href="#auth" aria-expanded="false" aria-controls="auth">
					  <i class="mdi mdi-account menu-icon"></i>
					  <span class="menu-title">个人用户设置</span>
					  <i class="menu-arrow"></i>
					</a>
					<div class="collapse" id="auth">
					  <ul class="nav flex-column sub-menu">
						<li class="nav-item"> <a class="nav-link" href="pages/samples/login.html">修改密码</a></li>
						<li class="nav-item"> <a class="nav-link" href="pages/samples/login-2.html">退出登录</a></li>
					  </ul>
					</div>
				  </li>
				</ul>
			  </nav>
			  
			        <!-- partial -->
			  <div class="main-panel">
				<div class="content-wrapper">
					<!-- InstanceBeginEditable name="ConetentArea" -->
					<div class="row">
						<div class="col-md-12 grid-margin stretch-card">
						  <div class="card">
							<div class="card-body">
							  <h4 class="card-title d-flex justify-content-between align-items-center">
								  <div>首页轮播图</div>
								  <a id="avatar" class="btn btn-primary btn-sm text-white">添加轮播图</a>
								  <input id="avatar_select" type="file" accept="image/gif,image/png,image/jpeg,image/bmp">
							  </h4>
							  <p class="card-description m-0">
								首页轮播图为察必小程序首页展示的轮播图，最多可以展示5张
							  </p>
							  
							  <div id="img_list" class="row m-0">
								  
								  <div class="card mr-3 text-center mt-3" style="width: 16rem;">请稍后，正在获取数据...</div>

							  </div>							 

								
								
							</div>
						  </div>
						</div>

					</div>
					
					
					<!--头像上传弹出层-->

					<div id="uppic_wrap" class="clearfix">
						<header class="up_header clearfix">
							<span style="float: left;"><b>轮播图上传</b>
								<i style="font-style:normal; font-size:12px;">(为保证图片呈现效果，对选取框限制了比例，请使用大于<b>710x1000</b>竖版尺寸图片,最大2MB)</i>
							</span>
							<span style="float: right; cursor: pointer;" onclick="$.closePopLayer();">关闭</span>
						</header>
						<div id="pop_img_wrap">
							<img id="cropbox" />
						</div>

						<div class="img-prev-wrap">
							<div id="avatat_prev">
								<!--<img id="preview" class="aaa" />-->
							</div>
							<div id="btn_save">保存</div>
						</div>

					</div>
					
					
					<div id="prev_wrap">
						<header class="up_header clearfix">
							<span style="float: left;"><b>轮播图预览</b><i style="font-style:normal; font-size:12px;">(图片最终将以<b>710x1000</b>竖版呈现,当前有缩放不是最终质量)</i></span>
							<span style="float: right; cursor: pointer;" onclick="$.closePopLayer();">关闭</span>
						</header>
						
						<div id="img_wrap">
							<img id="prev_img" src="" />
							<div id="text_area">
								<div class="form-group">
								  <label for="ipt_pic_tit">标题文字</label>
								  <input type="text" class="form-control" id="ipt_pic_tit" placeholder="标题文字,最多16个字符">
								</div>
								<button id="btn_confirm" class="btn btn-primary btn-lg btn-block">确定上传</button>
							</div>
						</div>

					</div>
					
					
					<script>
						getBannerList();
						var fileType='';
						
						$("#avatar").click(function(){
							var ImgCount=localStorage.getItem('IndexImgCount');
							console.log(ImgCount);
							if(ImgCount>=5){
								alert("首页轮播最多只能上传5张，请先删除现有，再进行上传");
								return false;
							}
							$("#avatar_select").click();
						});
						
						$("#btn_save").click(function(){
							var cas=$("#cropbox").cropper('getCroppedCanvas');
							var base64url=cas.toDataURL('image/png');
							$("#prev_img").attr("src",base64url);
							$.closePopLayer();
							$.showPopLayer({
								target:"prev_wrap",
								onPop:function(){
									$("#btn_confirm").click(function(){
									var title=$("#ipt_pic_tit").val();
									if($.trim(title)==""){
										alert("请输入标题");
										$("#ipt_pic_tit").val('').focus();
										return false;
									} 
									$(this).text("请稍后...").prop('disabled',true);
									$.post("https://customer.imotstudio.net/cabi/api/AddBanner",{
										  "Title": title,
										  "URL": "",
										  "IsLocked": false,
										  "Display": 999,
										  "type": 1
									}).then(function(res){
										var r=JSON.parse(res);
										if(r.code=="200"){
											var imgs=new Array();
											var type=fileType.substring(fileType.lastIndexOf(".")+1);
											var imgInfo = { ext: type, baseURL: base64url } //分别是：后缀，流文件
                    						imgs.push(imgInfo);
											return $.post("https://customer.imotstudio.net/cabi/api/AddBannerIMG",{
												imgs:imgs,
												ID: r.data.ID
											});
										}else{
											alert("出现错误，请联系管理员");
										}
										
									}).then(function(res){
										var r1=JSON.parse(res);
										if(r1.code=="200"){
											alert("上传成功");
											$.closePopLayer();
											getBannerList();
										}else{
											
											alert("上传失败");
										}
										
									}).always(function(){
										$('#btn_confirm').text("确定上传").prop('disabled',false);
									})
								})
							  },
							  onClose:function(){
								  $("#ipt_pic_tit").val('');
								  $("#btn_confirm").off('click');
							  }
							});
						});
						
						$("#avatar_select").change(function(){
							var size = 2 * 1024 * 1024;
							var file = this.files[0];
							var fileName = file.name;
							var fileSize = file.size;
							fileType = fileName.substring(fileName.lastIndexOf('.'), fileName.length).toLowerCase();
							if (fileType != '.gif' && fileType != '.jpeg' && fileType != '.png' && fileType != '.jpg') {
								alert("上传失败，请上传jpg,png格式的图片");
								return;
							}
							if (fileSize > size) {
								alert("上传失败，请上传2MB以内的图片。");
								return;
							}
							var reader = new FileReader();
							reader.readAsDataURL(file);
							reader.onload = function () {
								 // 通过 reader.result 来访问生成的 DataURL
								var url = reader.result;
								$("#cropbox,#preview").attr("src", url);
								initCropper();
								$.showPopLayer({
									target: "uppic_wrap",
									animate: false,
									onClose: function () {
										$('#avatar_select').prop('value', '');
										$('#cropbox').cropper('destroy');
									}
								});
							}
						})
						
						function initCropper(){
							$("#cropbox").cropper({
								aspectRatio: 71 / 100,
								viewMode:1,
								minCropBoxWidth:71,
								minCropBoxHeight:100,
								preview:"#avatat_prev"
							});
						}
						
						//获取首页滚动图片
						function getBannerList(){
							var d=new Date();
							$.get("https://customer.imotstudio.net/cabi/api/BannerList",{type:1,ts:d.getTime()}).done(function(res){
								if(res.Code==200){
									localStorage.setItem("IndexImgCount",res.Data.length);
									$("#img_list").empty();
									if(res.Data.length>0){
										$.each(res.Data,function(i,o){
											var h='<div class="card mr-3 text-center mt-3" style="width: 16rem;">\
												 <img src="'+o.Img+'" class="card-img-top" alt="...">\
												 <div class="card-body px-1">\
													<h5 class="card-title">'+o.Title+'</h5>\
													<a class="btn btn-danger btn-sm text-small text-white" onclick="del('+o.ID+')">删除</a>\
												 </div>\
											   </div>';
											$("#img_list").append(h);
										})	
									}
								}else{
									alert("出现错误。请联系管理员");
								}
							})
						}
						
						//删除照片
						function del(imgID){
							var d=new Date();
							console.log(imgID);
							$.post("https://customer.imotstudio.net/cabi/api/RemoveBanner",{ID:imgID}).done(function(res){
								var dr=JSON.parse(res);
								console.log(dr);
								if(dr.code=="200"){
									alert("删除成功");
									getBannerList();
								}
							})
						}
					</script>
					

					
					
					
					<!-- InstanceEndEditable -->
				</div>
				
				<footer id="footer_rights">
				    <span>察必后台管理系统 Copyright © 2020  All rights reserved.</span>
					<a href="https://www.imotstudio.net" target="_blank">内蒙古元本唐文化传媒有限公司提供技术支持</a>
				</footer>
				  
			  </div>
			   
		  </div>

		</div>
		
		<!-- container-scroller -->
		<!-- plugins:js -->

		<!-- endinject -->
		<!-- Plugin js for this page-->
		<!-- End plugin js for this page-->
		<!-- inject:js -->
		<script src="js/off-canvas.js"></script>
		<script src="js/hoverable-collapse.js"></script>
		<script src="js/template.js"></script>
		<!-- endinject -->
		<!-- Custom js for this page-->
		<!-- End custom js for this page-->
	</body>
<!-- InstanceEnd --></html>
